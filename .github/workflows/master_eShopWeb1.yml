# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy ASP.Net Core app to Azure Web App - eShopWeb1

on:
  push:
    branches:
      - master
  workflow_dispatch:

env: 
  AZURE_WEBAPP_NAME_1: eShopWeb1
  AZURE_WEBAPP_NAME_2: eShopWeb2
  AZURE_APIAPP_NAME: eShopOnWebPublicApiSS
  AZURE_WEBAPP_PACKAGE_PATH: '.'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '5.0.x'
        include-prerelease: true

    #Run Dotnet Build and Publish for web app
    - name: Web app build and publish
      run: |
      dotnet restore
      dotnet build ./src/Web/Web.csproj --configuration Release
      dotnet publish ./src/Web/Web.csproj - Release -o ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/webapp

    #Deploy WebApp1 to Azure Web apps
    - name: 'Run Azure webapp deploy action using publish profile credentials'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{env.AZURE_WEBAPP_NAME_1}}
        slot-name: 'stage'
        publish-profile: ${{ secrets.AZURE_WEBAPP1_PUBLISHPROFILE }}
        package: '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/webapp'

    #Deploy WebApp2 to Azure Web apps
    - name: 'Run Azure webapp deploy action using publish profile credentials'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{env.AZURE_WEBAPP_NAME_2}}
        slot-name: 'stage'
        publish-profile: ${{ secrets.AZURE_WEBAPP2_PUBLISHPROFILE }}
        package: '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/webapp'


    #Run Dotnet Build and Publish for api app
    - name: Api app build and publish
      run: |
      dotnet restore
      dotnet build ./src/PublicApi/PubliApi.csproj --configuration Release
      dotnet publish ./src/PublicApi/PubliApi.csproj - Release -o ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/apiapp

    #Deploy to Azure Web apps
    - name: 'Run Azure webapp deploy action using publish profile credentials'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{env.AZURE_APIAPP_NAME}}
        slot-name: 'stage'
        publish-profile: ${{ secrets.AZURE_APIAPP_PUBLISHPROFILE }}
        package: '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/apiapp'

        
      
